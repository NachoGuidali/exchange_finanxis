{% extends "base.html" %}
{% block title %}VerificaciÃ³n de comprobante{% endblock %}

{% block content %}
<section class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 py-8 space-y-6">

  <header class="reveal">
    <h1 class="text-2xl sm:text-3xl font-extrabold">ðŸ§¾ VerificaciÃ³n de comprobante</h1>
    <p class="text-white/60 mt-1">Detalles de la operaciÃ³n, cliente y validaciones de integridad.</p>
  </header>

  <!-- Resumen -->
  <div class="reveal rounded-2xl border border-white/10 bg-white/5 p-5 shadow-card">
    <div class="grid gap-2 sm:grid-cols-2 text-sm">
      <p><span class="text-white/60">NÃºmero:</span> <b>{{ numero }}</b></p>
      <p><span class="text-white/60">Fecha emisiÃ³n:</span> <b>{{ fecha_emision|date:"d/m/Y H:i:s" }}</b></p>
      <p><span class="text-white/60">Tipo:</span> <b>{{ tipo }}</b></p>
      <p><span class="text-white/60">Usuario:</span> <b>{{ usuario.username }}</b></p>
    </div>
  </div>

  <!-- Detalles -->
  <div class="reveal rounded-2xl border border-white/10 bg-white/5 p-5 shadow-card">
    <h2 class="mb-2 text-lg font-semibold">Detalles</h2>
    <div class="space-y-1 text-sm">
      <p><span class="text-white/60">Monto debitado:</span> <b>{{ snapshot.monto_debitado_fmt }}</b></p>
      {% if snapshot.comision_total_fmt %}<p><span class="text-white/60">ComisiÃ³n:</span> <b>{{ snapshot.comision_total_fmt }}</b></p>{% endif %}
      <p><span class="text-white/60">Monto origen:</span> <b>{{ snapshot.monto_origen_fmt }}</b></p>
      <p><span class="text-white/60">Tasa:</span> <b>{{ snapshot.tasa_fmt }}</b></p>
      <p><span class="text-white/60">Monto acreditado:</span> <b>{{ snapshot.monto_destino_fmt }}</b></p>
    </div>
  </div>

  <!-- Cliente -->
  <div class="reveal rounded-2xl border border-white/10 bg-white/5 p-5 shadow-card">
    <h2 class="mb-2 text-lg font-semibold">Cliente</h2>
    <div class="grid gap-2 sm:grid-cols-2 text-sm">
      <p><span class="text-white/60">Nombre:</span> <b>{{ cliente.nombre }}</b></p>
      <p><span class="text-white/60">Documento:</span> <b>{{ cliente.doc_tipo }} {{ cliente.doc_nro }}</b></p>
      <p><span class="text-white/60">Domicilio:</span> <b>{{ cliente.domicilio }}</b></p>
      <p><span class="text-white/60">Contacto:</span> <b>{{ cliente.email }}</b> â€” <b>{{ cliente.telefono }}</b></p>
      <p><span class="text-white/60">VerificaciÃ³n:</span>
        {% if cliente.estado_verificacion == 'aprobado' %}
          <span class="inline-flex items-center rounded-lg bg-emerald-400/10 text-emerald-300 px-2 py-0.5 text-xs">Aprobado</span>
        {% elif cliente.estado_verificacion == 'pendiente' %}
          <span class="inline-flex items-center rounded-lg bg-amber-400/10 text-amber-300 px-2 py-0.5 text-xs">Pendiente</span>
        {% else %}
          <span class="inline-flex items-center rounded-lg bg-rose-400/10 text-rose-300 px-2 py-0.5 text-xs">{{ cliente.estado_verificacion|title }}</span>
        {% endif %}
      </p>
    </div>
  </div>

  {% if snapshot.psav %}
  <!-- Proveedor -->
  <div class="reveal rounded-2xl border border-white/10 bg-white/5 p-5 shadow-card">
    <h2 class="mb-2 text-lg font-semibold">Proveedor</h2>
    <div class="grid gap-2 sm:grid-cols-2 text-sm">
      <p><span class="text-white/60">Nombre:</span> <b>{{ psav.nombre }}</b></p>
      <p><span class="text-white/60">CUIT:</span> <b>{{ psav.cuit }}</b></p>
      <p><span class="text-white/60">Domicilio:</span> <b>{{ psav.domicilio }}</b></p>
      <p><span class="text-white/60">Contacto:</span> <b>{{ psav.contacto }}</b></p>
      {% if psav.leyenda_psav %}<p><span class="text-white/60">Registro PSAV:</span> <b>{{ psav.leyenda_psav }}</b></p>{% endif %}
    </div>
  </div>
  {% endif %}

  {% if onchain.red or onchain.txid or onchain.destino or onchain.origen %}
  <!-- Blockchain -->
  <div class="reveal rounded-2xl border border-white/10 bg-white/5 p-5 shadow-card">
    <h2 class="mb-2 text-lg font-semibold">Datos blockchain</h2>
    <div class="grid gap-2 sm:grid-cols-2 text-sm">
      <p><span class="text-white/60">Red:</span> <b id="bc-red">{{ onchain.red|default:"â€”" }}</b></p>
      <p><span class="text-white/60">Wallet origen:</span>
        <span class="font-mono text-xs break-all">{{ onchain.origen|default:"â€”" }}</span>
        {% if onchain.origen %}<button class="ml-2 text-xs underline hover:no-underline" data-copy="{{ onchain.origen }}">Copiar</button>{% endif %}
      </p>
      <p><span class="text-white/60">Wallet destino:</span>
        <span class="font-mono text-xs break-all">{{ onchain.destino|default:"â€”" }}</span>
        {% if onchain.destino %}<button class="ml-2 text-xs underline hover:no-underline" data-copy="{{ onchain.destino }}">Copiar</button>{% endif %}
      </p>
      <p><span class="text-white/60">TXID:</span>
        <span class="font-mono text-xs break-all" id="bc-txid">{{ onchain.txid|default:"â€”" }}</span>
        {% if onchain.txid %}<button class="ml-2 text-xs underline hover:no-underline" data-copy="{{ onchain.txid }}">Copiar</button>{% endif %}
      </p>
      <p><span class="text-white/60">Fecha/hora TX:</span> <b>{{ onchain.fecha_hora|default:"â€”" }}</b></p>
    </div>
  </div>
  {% endif %}

  <!-- Integridad -->
  <div class="reveal rounded-2xl border border-white/10 bg-white/5 p-5 shadow-card">
    <h2 class="mb-2 text-lg font-semibold">Integridad</h2>
    <div class="text-sm space-y-2">
      <p><span class="text-white/60">SHA-256 (guardado):</span>
        <code class="font-mono text-xs break-all" id="sha-saved">{{ pdf_sha256|default:"â€”" }}</code>
        {% if pdf_sha256 %}<button class="ml-2 text-xs underline hover:no-underline" data-copy="{{ pdf_sha256 }}">Copiar</button>{% endif %}
      </p>
      {% if recomputed_sha256 %}
      <p><span class="text-white/60">SHA-256 (recalculado):</span>
        <code class="font-mono text-xs break-all" id="sha-recalc">{{ recomputed_sha256 }}</code>
        <button class="ml-2 text-xs underline hover:no-underline" data-copy="{{ recomputed_sha256 }}">Copiar</button>
      </p>
      {% endif %}
      {% if pdf_ok is not None %}
        {% if pdf_ok %}
          <p class="text-emerald-300"><b>OK:</b> el hash del PDF coincide.</p>
        {% else %}
          <p class="text-rose-300"><b>ATENCIÃ“N:</b> el hash del PDF NO coincide.</p>
        {% endif %}
      {% endif %}
    </div>
  </div>

  <!-- Acciones -->
  <div class="reveal flex flex-wrap gap-3">
    <a href="{% url 'descargar_boleto' numero=boleto.numero %}"
       class="rounded-xl bg-primary text-dark font-semibold px-4 py-2.5 text-sm shadow-soft hover:opacity-90">
      Descargar PDF
    </a>
    <a href="{% url 'comprobantes' %}"
       class="rounded-xl border border-white/10 bg-white/5 px-4 py-2.5 text-sm hover:bg-white/10">
      Volver a comprobantes
    </a>
    
  </div>

</section>

<!-- AnimaciÃ³n + copiar al portapapeles -->
<script>
(function(){
  // reveal
  const els = document.querySelectorAll('.reveal');
  const io = new IntersectionObserver((entries)=>{
    entries.forEach(({isIntersecting,target})=>{
      if(isIntersecting){ target.classList.add('show'); io.unobserve(target); }
    });
  }, {rootMargin:'0px 0px -12% 0px', threshold:0.08});
  els.forEach(el=>io.observe(el));

  // copiar
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-copy]');
    if(!btn) return;
    const text = btn.getAttribute('data-copy');
    navigator.clipboard.writeText(text).then(()=>{
      btn.textContent = 'Copiado';
      setTimeout(()=>btn.textContent='Copiar', 1200);
    });
  });
})();
</script>
{% endblock %}
