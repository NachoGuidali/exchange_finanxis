{% extends "base.html" %}
{% block title %}Dashboard ‚Äî Finanxis{% endblock %}
{% block meta_description %}Panel de trading con saldos, PnL, composici√≥n de cartera, cotizaciones y actividad reciente.{% endblock %}

{% block content %}
<script>document.documentElement.classList.add('js');</script>

<style>
  /* Fallback: visible por defecto si JS no carga */
  .reveal{opacity:1; transform:none}

  /* Solo si hay JS, aplicamos la animaci√≥n */
  .js .reveal{
    opacity:0;
    transform:translateY(22px);
    transition:opacity .6s cubic-bezier(.21,.67,.15,.99), transform .6s cubic-bezier(.21,.67,.15,.99);
  }
  .js .reveal.show{opacity:1; transform:none}
</style>

<!-- üîî Notificaciones (flotante) -->
<div id="notiFab" class="fixed right-2 sm:right-4 top-24 z-40">
  <button id="btnNotif" class="relative h-11 w-11 rounded-xl border border-gray-200 bg-white shadow-card hover:bg-gray-50">üîî
    <span id="badgeNotif" class="hidden absolute -top-1.5 -right-1.5 bg-primary text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center">0</span>
  </button>
  <div id="boxNotif" class="hidden mt-2 w-[min(90vw,22rem)] rounded-2xl border border-gray-200 bg-white shadow-lg max-h-[70vh] overflow-y-auto">
    <div class="px-4 py-3 border-b border-gray-200 text-sm font-semibold">Notificaciones</div>
    <ul id="listNotif" class="divide-y divide-gray-100 text-sm"></ul>
  </div>
</div>

<section class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8 space-y-6">

  <!-- ===== Encabezado / Estado de cuenta / CTA ===== -->
  <header class="reveal">
    <div class="rounded-2xl border border-gray-200 bg-white p-5 lg:p-6 shadow-soft">
      <div class="grid gap-4 lg:grid-cols-12">
        <div class="lg:col-span-7">
          <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900">Hola, {{ request.user.username }}</h1>
          <p class="text-gray-600 mt-1">Seguimiento de tu cartera y accesos r√°pidos para operar.</p>

          <div class="mt-3 flex flex-wrap items-center gap-2 text-xs">
            <span class="inline-flex items-center gap-1 rounded-lg border border-gray-200 bg-gray-50 px-2 py-1">
              {% if request.user.estado_verificacion == 'aprobado' %}‚úÖ KYC verificado{% elif request.user.estado_verificacion == 'pendiente' %}‚åõ KYC pendiente{% else %}‚ö†Ô∏è KYC requerido{% endif %}
            </span>
            <!-- <span class="inline-flex items-center gap-1 rounded-lg border border-gray-200 bg-gray-50 px-2 py-1">
              {% if request.user.has_2fa %}üîí 2FA activo{% else %}üîì Activ√° 2FA{% endif %}
            </span> -->
            <span class="inline-flex items-center gap-1 rounded-lg border border-gray-200 bg-gray-50 px-2 py-1">üßë‚Äçüíº Soporte 24/7</span>
            <span class="inline-flex items-center gap-1 rounded-lg border border-gray-200 bg-gray-50 px-2 py-1">üè™ Retiros en sucursales</span>
          </div>
        </div>

        <!-- Acciones clave -->
        <div class="lg:col-span-5 flex flex-col sm:flex-row lg:flex-col gap-3">
          <a href="{% url 'operar' %}" class="flex-1 inline-flex items-center justify-center rounded-xl bg-primary text-dark font-semibold px-5 py-3 text-sm shadow-soft hover:opacity-90">üöÄ Nueva operaci√≥n</a>
          <div class="flex gap-3">
            <a href="{% url 'agregar_saldo' %}" class="flex-1 rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-700 px-4 py-3 text-sm text-center hover:bg-emerald-100">üí∏ Ingresar</a>
            <a href="{% url 'solicitar_retiro' %}" class="flex-1 rounded-xl border border-amber-200 bg-amber-50 text-amber-700 px-4 py-3 text-sm text-center hover:bg-amber-100">üèß Retirar</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- ===== Cabecera de trading: Saldos + Ticker + Atajos ===== -->
  <section class="reveal grid gap-6 lg:grid-cols-12">
    <!-- Saldos -->
    <div class="lg:col-span-5 rounded-2xl border border-gray-200 bg-white p-5">
      <h3 class="text-sm font-semibold text-gray-900">Saldos disponibles</h3>
      <div class="mt-3 grid grid-cols-3 gap-3">
        <div class="rounded-xl border border-gray-200 bg-gray-50 p-3">
          <div class="text-xs text-gray-600">ARS</div>
          <div class="mt-1 text-2xl font-extrabold text-gray-900">${{ request.user.saldo_ars }}</div>
        </div>
        <div class="rounded-xl border border-gray-200 bg-gray-50 p-3">
          <div class="text-xs text-gray-600">USDT</div>
          <div class="mt-1 text-2xl font-extrabold text-gray-900">{{ request.user.saldo_usdt }}</div>
        </div>
        <div class="rounded-xl border border-gray-200 bg-gray-50 p-3">
          <div class="text-xs text-gray-600">USD</div>
          <div class="mt-1 text-2xl font-extrabold text-gray-900">{{ request.user.saldo_usd|default:"0.00" }}</div>
        </div>
      </div>
      <p class="mt-2 text-[11px] text-gray-500">Tip: pod√©s exportar movimientos desde <a href="{% url 'mis_movimientos' %}" class="underline">Mis movimientos</a>.</p>
    </div>

    <!-- Ticker / Cotizaciones -->
    <div class="lg:col-span-4 rounded-2xl border border-gray-200 bg-white p-5">
      <h3 class="text-sm font-semibold text-gray-900">Cotizaciones</h3>
      <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
        <div class="rounded-xl border border-gray-200 bg-gray-50 p-3">
          <div class="text-xs text-gray-600">USDT</div>
          <div class="mt-1 flex justify-between"><span class="text-gray-700">Compra</span><span class="font-semibold">${{ cot_usdt.compra }}</span></div>
          <div class="mt-1 flex justify-between"><span class="text-gray-700">Venta</span><span class="font-semibold">${{ cot_usdt.venta }}</span></div>
        </div>
        <div class="rounded-xl border border-gray-200 bg-gray-50 p-3">
          <div class="text-xs text-gray-600">USD</div>
          <div class="mt-1 flex justify-between"><span class="text-gray-700">Compra</span><span class="font-semibold">${{ cot_usd.compra }}</span></div>
          <div class="mt-1 flex justify-between"><span class="text-gray-700">Venta</span><span class="font-semibold">${{ cot_usd.venta }}</span></div>
        </div>
      </div>
      <div class="mt-3 flex gap-2">
        <a href="{% url 'operar' %}" class="flex-1 rounded-lg bg-primary text-dark text-xs font-semibold px-3 py-2 text-center shadow-soft hover:opacity-90">Operar ahora</a>
        <a href="{% url 'agregar_saldo' %}" class="flex-1 rounded-lg border border-gray-200 bg-white text-xs px-3 py-2 text-center hover:bg-gray-50">Ingresa saldo</a>
      </div>
    </div>

    <!-- Atajos -->
    <div class="lg:col-span-3 rounded-2xl border border-gray-200 bg-primary/5 p-5">
      <h3 class="text-sm font-semibold text-gray-900">Atajos</h3>
      <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
        <a class="rounded-xl border border-gray-200 bg-white px-3 py-2 text-center hover:bg-gray-50" href="{% url 'comprobantes' %}">üßæ Comprobantes</a>
        <a class="rounded-xl border border-gray-200 bg-white px-3 py-2 text-center hover:bg-gray-50" href="{% url 'mis_movimientos' %}">‚ò∞ Movimientos</a>
        <a class="rounded-xl border border-gray-200 bg-white px-3 py-2 text-center hover:bg-gray-50" href="{% url 'soporte' %}">üí¨ Ayuda</a>
        <!-- <a class="rounded-xl border border-gray-200 bg-white px-3 py-2 text-center hover:bg-gray-50" href="#">üéÅ Referidos</a> -->
      </div>
    </div>
  </section>

  <!-- ===== Visualizaciones: PnL + Composici√≥n ===== -->
  <section class="reveal grid gap-6 lg:grid-cols-12">
    <div class="lg:col-span-8 rounded-2xl border border-gray-200 bg-white p-5">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold text-gray-900">Evoluci√≥n 30 d√≠as ‚Äî PnL / Flujo</h3>
        <span class="text-xs text-gray-500">ARS (precio compra)</span>
      </div>
      <canvas id="fx-line" height="90"></canvas>
      <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="rounded-xl border border-gray-200 bg-gray-50 p-3">
          <p class="text-[11px] text-gray-600">Ingresado</p>
          <p class="text-lg font-bold text-gray-900">${{ kpi_total_ingresado|floatformat:2 }}</p>
        </div>
        <div class="rounded-xl border border-gray-200 bg-gray-50 p-3">
          <p class="text-[11px] text-gray-600">Retirado</p>
          <p class="text-lg font-bold text-gray-900">${{ kpi_total_retirado|floatformat:2 }}</p>
        </div>
        <div class="rounded-xl border border-gray-200 bg-gray-50 p-3">
          <p class="text-[11px] text-gray-600">Flujo neto</p>
          <p class="text-lg font-bold text-gray-900">${{ kpi_flujo_neto|floatformat:2 }}</p>
        </div>
        <div class="rounded-xl border border-gray-200 bg-gray-50 p-3">
          <p class="text-[11px] text-gray-600">Cartera (ARS)</p>
          <p class="text-lg font-bold text-gray-900">${{ kpi_cartera_ars|floatformat:2 }}</p>
        </div>
      </div>
    </div>

    <div class="lg:col-span-4 rounded-2xl border border-gray-200 bg-white p-5">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">Composici√≥n de cartera</h3>
      <canvas id="fx-donut" height="120"></canvas>
      <p class="text-[11px] text-gray-600 mt-2">Ponderado a ARS. El tooltip muestra unidades originales.</p>
    </div>
  </section>

  <!-- ===== Notificaciones recientes ===== -->
  <!-- <section class="reveal rounded-2xl border border-gray-200 bg-white p-5">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-gray-900">Notificaciones recientes</h3>
      <a href="#" class="text-xs text-primary underline">Ver todas</a>
    </div>
    <ul class="mt-3 divide-y divide-gray-100 text-sm">
      {% for n in notificaciones %}
        <li class="py-2 flex items-start gap-2">
          <span class="mt-1 text-primary">‚óè</span>
          <span class="text-gray-700">{{ n.fecha|date:"d/m/Y H:i" }} ‚Äî {{ n.mensaje }} {% if not n.leida %}<strong class="text-primary">(nuevo)</strong>{% endif %}</span>
        </li>
      {% empty %}
        <li class="py-4 text-gray-500">No hay notificaciones.</li>
      {% endfor %}
    </ul>
  </section> -->

  <!-- ===== Actividad reciente ===== -->
  <section class="reveal rounded-2xl border border-gray-200 bg-white p-5">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-lg font-semibold text-gray-900">Actividad reciente</h3>
      <a href="{% url 'mis_movimientos' %}" class="text-sm text-primary underline">Ver todo</a>
    </div>
    <div class="overflow-x-auto rounded-xl border border-gray-200 bg-white">
      <table class="w-full text-xs md:text-sm">
        <thead class="bg-gray-50 text-gray-600">
          <tr class="[&>th]:px-3 [&>th]:py-2 [&>th]:font-semibold [&>th]:text-left">
            <th>Fecha</th><th>Tipo</th><th>Moneda</th>
            <th class="text-right">Monto</th><th class="text-right">Saldo antes</th><th class="text-right">Saldo despu√©s</th>
            <th>Descripci√≥n</th><th>ID</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {% for m in movimientos %}
          <tr class="hover:bg-gray-50 transition">
            <td class="px-3 py-2 whitespace-nowrap text-gray-700">{{ m.fecha }}</td>
            <td class="px-3 py-2 text-gray-700">{{ m.get_tipo_display }}</td>
            <td class="px-3 py-2 text-gray-700">{{ m.moneda }}</td>
            <td class="px-3 py-2 text-right text-gray-900">${{ m.monto }}</td>
            <td class="px-3 py-2 text-right text-gray-900">${{ m.saldo_antes }}</td>
            <td class="px-3 py-2 text-right text-gray-900">${{ m.saldo_despues }}</td>
            <td class="px-3 py-2 text-gray-700">{{ m.descripcion }}</td>
            <td class="px-3 py-2 font-mono text-xs text-gray-600">{{ m.codigo }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="8" class="px-3 py-6 text-center text-gray-500">Sin movimientos a√∫n.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

</section>

<!-- ===== Scripts ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

{# Datos seguros (si no existen en contexto, caer√°n a vac√≠os) #}
{{ chart_labels|json_script:"fxLabels" }}
{{ chart_deps|json_script:"fxDeps" }}
{{ chart_rets|json_script:"fxRets" }}
{{ chart_net|json_script:"fxNet" }}

{{ comp_labels|json_script:"cmpLabels" }}
{{ comp_units|json_script:"cmpUnits" }}
{{ comp_ars|json_script:"cmpArs" }}


<script>
/* ==== REVEAL ROBUSTO (fix: usar "target" en vez de "t") ==== */
(function () {
  const els = document.querySelectorAll('.reveal');

  // Si no hay JS o no hay elementos, nada que hacer
  if (!('IntersectionObserver' in window) || !els.length) {
    els.forEach(el => el.classList.add('show'));
    return;
  }

  const io = new IntersectionObserver((entries) => {
    entries.forEach(({ isIntersecting, target }) => {  // <<<<<< FIX ACA
      if (isIntersecting) {
        target.classList.add('show');
        io.unobserve(target);
      }
    });
  }, { rootMargin: '0px 0px -10% 0px', threshold: 0.08 });

  els.forEach(el => io.observe(el));

  // Fallback extra: asegura mostrar todo si algo qued√≥ sin observar
  setTimeout(() => {
    document.querySelectorAll('.reveal:not(.show)').forEach(el => el.classList.add('show'));
  }, 900);
})();
</script>

<script>
/* ==== CHARTS (Finanxis colors) ==== */
(function () {
  // Paleta Finanxis
  const FX = {
    primary:  '#FF1129',                        // rojo Finanxis
    ink:      '#111827',                        // gris oscuro (texto fuerte)
    cyan:     '#0EA5E9',                        // acento fr√≠o
    tick:     '#4B5563',
    grid:     'rgba(0,0,0,.06)',
    alpha: {
      primary: 'rgba(255, 17, 41, 0.14)',
      ink:     'rgba(17, 24, 39, 0.10)',
      cyan:    'rgba(14, 165, 233, 0.16)',
    }
  };

  // ===== Datos existentes (no tocamos nombres/estructura)
  const L = JSON.parse(document.getElementById('fxLabels')?.textContent || '[]');
  const D = JSON.parse(document.getElementById('fxDeps')?.textContent   || '[]');
  const R = JSON.parse(document.getElementById('fxRets')?.textContent   || '[]');
  const N = JSON.parse(document.getElementById('fxNet')?.textContent    || '[]');

  // ===== L√≠nea: Evoluci√≥n 30 d√≠as ‚Äî PnL / Flujo (colores Finanxis)
  const c1 = document.getElementById('fx-line');
  if (c1 && window.Chart){
    new Chart(c1, {
      type: 'line',
      data: {
        labels: L,
        datasets: [
          {
            label:'Ingresos',
            data: D,
            borderColor: FX.primary,
            backgroundColor: FX.alpha.primary,
            borderWidth: 2,
            pointRadius: 0,
            tension: .25
          },
          {
            label:'Retiros',
            data: R,
            borderColor: FX.ink,
            backgroundColor: FX.alpha.ink,
            borderWidth: 2,
            pointRadius: 0,
            tension: .25
          },
          {
            label:'Neto',
            data: N,
            borderColor: FX.cyan,
            backgroundColor: FX.alpha.cyan,
            borderWidth: 2,
            pointRadius: 0,
            tension: .25
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: {
          x: { grid: { display: false }, ticks: { color: FX.tick } },
          y: { grid: { color: FX.grid },   ticks: { color: FX.tick } }
        }
      }
    });
  }

  // ===== Donut: Composici√≥n (colores Finanxis)
  const L2 = JSON.parse(document.getElementById('cmpLabels')?.textContent || '[]'); // p.ej. ['ARS','USDT','USD']
  const U2 = JSON.parse(document.getElementById('cmpUnits') ?.textContent || '[]');
  const A2 = JSON.parse(document.getElementById('cmpArs')   ?.textContent || '[]');

  const c2 = document.getElementById('fx-donut');
  if (c2 && window.Chart){
    // Mapeo por etiqueta para que el color sea consistente sin importar el orden
    const colorMap = { 'ARS': FX.ink, 'USDT': FX.primary, 'USD': FX.cyan };
    const bg = L2.map(l => colorMap[l] || FX.cyan);

    new Chart(c2, {
      type: 'doughnut',
      data: {
        labels: L2,
        datasets: [{
          data: A2,
          backgroundColor: bg,
          borderColor: bg,
          borderWidth: 1
        }]
      },
      options: {
        cutout: '60%',
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const i = ctx.dataIndex;
                const label = L2[i] ?? '';
                const ars   = Number(A2[i] ?? 0).toFixed(2);
                const unit  = Number(U2[i] ?? 0);
                const unitFmt = (label === 'USDT') ? unit.toFixed(6) : unit.toFixed(2);
                return `${label}: ${unitFmt} ‚Ä¢ $${ars} ARS`;
              }
            }
          }
        }
      }
    });
  }
})();
</script>


<script>
/* ==== NOTIFICACIONES (simple) ==== */
(function(){
  const btn = document.getElementById('btnNotif');
  const box = document.getElementById('boxNotif');
  const list= document.getElementById('listNotif');
  const badge= document.getElementById('badgeNotif');

  async function json(u){ const r=await fetch(u,{headers:{'X-Requested-With':'XMLHttpRequest'}}); if(!r.ok) throw new Error(); return r.json(); }
  async function contar(){
    try{
      const d = await json('/notificaciones/contar/');
      const n = Number(d?.no_leidas||0);
      if(n>0){ badge.textContent=n>9?'9+':n; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
    }catch(e){}
  }
  async function cargar(){
    try{
      const d = await json('/notificaciones/ajax/');
      list.innerHTML = '';
      const arr = d?.notificaciones||[];
      if(!arr.length){ list.innerHTML = '<li class="px-4 py-3 text-gray-500">Sin notificaciones.</li>'; return; }
      arr.forEach(n=>{
        const li = document.createElement('li');
        li.className='px-4 py-3 hover:bg-gray-50'; li.textContent=`${n.fecha}: ${n.mensaje}`;
        list.appendChild(li);
      });
      badge.classList.add('hidden');
    }catch(e){ list.innerHTML='<li class="px-4 py-3 text-rose-500">Error al cargar.</li>'; }
  }
  btn?.addEventListener('click', (e)=>{ e.stopPropagation(); box.classList.toggle('hidden'); if(!box.classList.contains('hidden')) cargar(); });
  document.addEventListener('click', (e)=>{ if(btn && box && !btn.contains(e.target) && !box.contains(e.target)) box.classList.add('hidden'); });
  contar(); setInterval(contar, 60000);
})();
</script>
{% endblock %}
