{% extends "base.html" %}
{% block title %}Panel de Administraci√≥n ‚Äî Full Finanzas{% endblock %}
{% block meta_description %}Control de KYC, dep√≥sitos, retiros y movimientos del exchange.{% endblock %}

{% block content %}
<section class="max-w-7xl mx-auto px-4 py-8">

  <!-- Header + b√∫squeda global -->
  <header class="mb-6 flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
    <div>
      <h1 class="text-2xl sm:text-3xl font-extrabold">Panel de Administraci√≥n</h1>
      <p class="text-black/70">Gestion√° verificaci√≥n, dep√≥sitos, retiros y movimientos.</p>
    </div>
    <form method="get" action="" class="w-full md:w-auto" role="search" aria-label="B√∫squeda global">
      <div class="flex gap-2">
        <input
          name="q"
          value="{{ request.GET.q }}"
          placeholder="Buscar usuario, email, DNI, c√≥digo‚Ä¶"
          class="w-full md:w-80 rounded-lg border border-white/10 bg-white text-black px-3 py-2 focus:outline-none focus:ring-2 focus:ring-neon"
          aria-label="Buscar"
        />
        <button class="rounded-lg bg-neon text-black font-semibold px-4 py-2">Buscar</button>
      </div>
    </form>
  </header>
  <section class="max-w-7xl mx-auto px-4 py-6 space-y-6">
  <header class="flex flex-col gap-2">
    <h1 class="text-2xl sm:text-3xl font-extrabold">Administraci√≥n</h1>
    <p class="text-white/70 text-sm">Atajos r√°pidos a m√≥dulos operativos.</p>
  </header>

  <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
    <a href="{% url 'panel_depositos' %}" class="card p-5 hover:bg-white/5 transition">
      <div class="flex items-center justify-between">
        <div class="font-semibold">Dep√≥sitos ARS</div>
        {% if kpi_depositos_pend %}
          <span class="rounded-full bg-neon/20 text-neon px-2 py-[2px] text-[11px]">
            {{ kpi_depositos_pend }}
          </span>
        {% endif %}
      </div>
      <p class="text-white/60 text-sm mt-1">Ingresos por transferencia/local.</p>
    </a>

    <a href="{% url 'panel_depositos_usdt' %}" class="card p-5 hover:bg-white/5 transition">
      <div class="font-semibold">Dep√≥sitos USDT</div>
      <p class="text-white/60 text-sm mt-1">On-chain / CEX.</p>
    </a>

    <a href="{% url 'panel_retiros' %}" class="card p-5 hover:bg-white/5 transition">
      <div class="flex items-center justify-between">
        <div class="font-semibold">Retiros</div>
        {% with a=kpi_retiros_ars_pend|default:0 c=kpi_retiros_crypto_pend|default:0 %}
          {% if a or c %}
            <span class="rounded-full bg-neon/20 text-neon px-2 py-[2px] text-[11px]">
              {{ a|add:c }}
            </span>
          {% endif %}
        {% endwith %}
      </div>
      <p class="text-white/60 text-sm mt-1">ARS & cripto.</p>
    </a>

    <a href="{% url 'exchange_dashboard' %}" class="card p-5 hover:bg-white/5 transition">
      <div class="font-semibold">Contabilidad</div>
      <p class="text-white/60 text-sm mt-1">Caja, rentas y flujo global.</p>
    </a>

    <a href="{% url 'panel_admin' %}#movs" class="card p-5 hover:bg-white/5 transition">
      <div class="font-semibold">Movimientos</div>
      <p class="text-white/60 text-sm mt-1">Listado y auditor√≠a.</p>
    </a>

    <a href="{% url 'admin_usuarios_list' %}" class="card p-5 hover:bg-white/5 transition">
      <div class="font-semibold">Usuarios</div>
      <p class="text-white/60 text-sm mt-1">KYC, l√≠mites y estado.</p>
    </a>
  </div>
</section>

  <!-- KPIs -->
  <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4 mb-8">
    <div class="card p-4 shadow-soft">
      <p class="text-black/60 text-sm">Usuarios pendientes KYC</p>
      <p class="text-2xl font-bold">{{ kpi_pendientes_kyc|default:"0" }}</p>
    </div>
    <div class="card p-4 shadow-soft">
      <p class="text-black/60 text-sm">Dep√≥sitos pendientes</p>
      <p class="text-2xl font-bold">{{ kpi_depositos_pend|default:"0" }}</p>
    </div>
    <div class="card p-4 shadow-soft">
      <p class="text-black/60 text-sm">Retiros ARS pendientes</p>
      <p class="text-2xl font-bold">{{ kpi_retiros_ars_pend|default:"0" }}</p>
    </div>
    <div class="card p-4 shadow-soft">
      <p class="text-black/60 text-sm">Retiros CRYPTO pendientes</p>
      <p class="text-2xl font-bold">{{ kpi_retiros_crypto_pend|default:"0" }}</p>
    </div>
  </div>

  <!-- Tabs -->
  <div class="mb-6 flex flex-wrap gap-2">
    <a href="#kyc"            class="tab-btn rounded-lg border border-white/10 px-3 py-2 hover:bg-white/5" data-tab="kyc">KYC</a>
    <a href="#retiros"        class="tab-btn rounded-lg border border-white/10 px-3 py-2 hover:bg-white/5" data-tab="retiros">Retiros ARS</a>
    <a href="#retiros-crypto" class="tab-btn rounded-lg border border-white/10 px-3 py-2 hover:bg-white/5" data-tab="retiros-crypto">Retiros CRYPTO</a>
    <a href="#depositos"      class="tab-btn rounded-lg border border-white/10 px-3 py-2 hover:bg-white/5" data-tab="depositos">Dep√≥sitos</a>
    <a href="#movs"           class="tab-btn rounded-lg border border-white/10 px-3 py-2 hover:bg-white/5" data-tab="movs">Movimientos</a>
    <a href="#export"         class="tab-btn rounded-lg border border-white/10 px-3 py-2 hover:bg-white/5" data-tab="export">Exportar</a>
  </div>

  <!-- KYC -->
  <section id="panel-kyc" data-panel="kyc" class="space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold">Usuarios con verificaci√≥n pendiente</h2>
      <p class="text-sm text-black/60">Hac√© click en el usuario para abrir su perfil.</p>
    </div>

    <div class="overflow-x-auto card p-0">
      <table class="w-full text-sm">
        <thead class="bg-white/5 text-accent">
          <tr>
            <th class="px-3 py-2 text-left">Usuario</th>
            <th class="px-3 py-2 text-left">Email</th>
            <th class="px-3 py-2 text-left">DNI frente</th>
            <th class="px-3 py-2 text-left">DNI dorso</th>
            <th class="px-3 py-2 text-left">Estado</th>
            <th class="px-3 py-2 text-left">Acciones</th>
            <th class="px-3 py-2 text-left">Historial</th>
          </tr>
        </thead>
        <tbody>
          {% for u in usuarios %}
            {% if u.estado_verificacion != 'aprobado' %}
            <tr class="hover:bg-white/5">
              <td class="px-3 py-2">
                <a class="text-accent hover:underline" href="{% url 'admin_usuario_perfil' u.id %}">{{ u.username }}</a>
              </td>
              <td class="px-3 py-2">{{ u.email }}</td>
              <td class="px-3 py-2">
                {% if u.dni_frente %}
                  <button type="button" class="thumb-btn underline text-white/80 hover:text-neon" data-img="{{ u.dni_frente.url }}">Ver</button>
                {% else %}<span class="text-black/40">‚Äî</span>{% endif %}
              </td>
              <td class="px-3 py-2">
                {% if u.dni_dorso %}
                  <button type="button" class="thumb-btn underline text-white/80 hover:text-neon" data-img="{{ u.dni_dorso.url }}">Ver</button>
                {% else %}<span class="text-black/40">‚Äî</span>{% endif %}
              </td>
              <td class="px-3 py-2 capitalize">
                <span class="px-2 py-0.5 rounded border text-xs
                  {% if u.estado_verificacion == 'aprobado' %} border-emerald-400 text-emerald-300
                  {% elif u.estado_verificacion == 'pendiente' %} border-amber-400 text-amber-300
                  {% elif u.estado_verificacion == 'rechazado' %} border-red-400 text-red-300
                  {% else %} border-white/20 text-white/80 {% endif %}">
                  {{ u.estado_verificacion }}
                </span>
              </td>
              <td class="px-3 py-2">
                <form method="post" action="{% url 'cambiar_estado_verificacion' u.id %}" class="flex items-center gap-2">
                  {% csrf_token %}
                  <label class="sr-only" for="estado-{{ u.id }}">Estado</label>
                  <select id="estado-{{ u.id }}" name="estado"
                          class="rounded-md border border-white/10 bg-white text-black px-2 py-1 focus:outline-none focus:ring-2 focus:ring-neon">
                    <option value="pendiente" {% if u.estado_verificacion == 'pendiente' %}selected{% endif %}>Pendiente</option>
                    <option value="aprobado" {% if u.estado_verificacion == 'aprobado' %}selected{% endif %}>Aprobado</option>
                    <option value="rechazado" {% if u.estado_verificacion == 'rechazado' %}selected{% endif %}>Rechazado</option>
                  </select>
                  <button class="rounded-md bg-neon text-black px-3 py-1 font-semibold">Actualizar</button>
                </form>
              </td>
              <td class="px-3 py-2">
                <a class="rounded-md border border-white/10 px-3 py-1 hover:bg-white/5" href="{% url 'historial_usuario' u.id %}">Ver historial</a>
              </td>
            </tr>
            {% endif %}
          {% empty %}
            <tr><td colspan="7" class="px-3 py-4 text-black/60 text-center">Sin pendientes.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Retiros ARS -->
  <section id="panel-retiros" data-panel="retiros" class="space-y-4 hidden">
    <h2 class="text-lg font-semibold">Retiros pendientes (ARS)</h2>
    <div class="overflow-x-auto card p-0">
      <table class="w-full text-sm">
        <thead class="bg-white/5 text-accent">
          <tr>
            <th class="px-3 py-2 text-left">Usuario</th>
            <th class="px-3 py-2 text-left">Monto</th>
            <th class="px-3 py-2 text-left">Alias</th>
            <th class="px-3 py-2 text-left">CBU</th>
            <th class="px-3 py-2 text-left">Banco</th>
            <th class="px-3 py-2 text-left">Estado</th>
            <th class="px-3 py-2 text-left">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for r in retiros %}
            {% if r.estado != 'enviado' %}
            <tr class="hover:bg-white/5">
              <td class="px-3 py-2"><a class="text-accent hover:underline" href="{% url 'admin_usuario_perfil' r.usuario.id %}">{{ r.usuario.username }}</a></td>
              <td class="px-3 py-2">${{ r.monto }}</td>
              <td class="px-3 py-2">{{ r.alias|default:"‚Äî" }}</td>
              <td class="px-3 py-2 break-all">{{ r.cbu|default:"‚Äî" }}</td>
              <td class="px-3 py-2">{{ r.banco|default:"‚Äî" }}</td>
              <td class="px-3 py-2 capitalize">
                <span class="px-2 py-0.5 rounded border text-xs
                  {% if r.estado == 'aprobado' %} border-emerald-400 text-emerald-300
                  {% elif r.estado == 'pendiente' %} border-amber-400 text-amber-300
                  {% elif r.estado == 'enviado' %} border-sky-400 text-sky-300
                  {% else %} border-red-400 text-red-300 {% endif %}">
                  {{ r.estado }}
                </span>
              </td>
              <td class="px-3 py-2">
                <div class="flex flex-wrap gap-2">
                  {% if r.estado == 'pendiente' %}
                  <form method="post" action="{% url 'aprobar_retiro' r.id %}">{% csrf_token %}
                    <button class="rounded-md bg-neon text-black px-3 py-1 font-semibold">Aprobar</button>
                  </form>
                  <form method="post" action="{% url 'rechazar_retiro_ars' r.id %}">{% csrf_token %}
                    <button class="rounded-md border border-white/10 px-3 py-1 hover:bg-white/5">Rechazar</button>
                  </form>
                  {% endif %}
                  {% if r.estado == 'aprobado' %}
                  <form method="post" action="{% url 'enviar_retiro' r.id %}">{% csrf_token %}
                    <button class="rounded-md border border-white/10 px-3 py-1 hover:bg-white/5">Marcar enviado</button>
                  </form>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endif %}
          {% empty %}
            <tr><td colspan="7" class="px-3 py-4 text-black/60 text-center">Sin retiros pendientes.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Retiros CRYPTO -->
  <section id="panel-retiros-crypto" data-panel="retiros-crypto" class="space-y-4 hidden">
    <h2 class="text-lg font-semibold">Retiros CRYPTO</h2>
    <div class="overflow-x-auto card p-0">
      <table class="w-full text-sm">
        <thead class="bg-white/5 text-accent">
          <tr>
            <th class="px-3 py-2 text-left">Usuario</th>
            <th class="px-3 py-2 text-left">Moneda</th>
            <th class="px-3 py-2 text-left">Monto</th>
            <th class="px-3 py-2 text-left">Wallet</th>
            <th class="px-3 py-2 text-left">Estado</th>
            <th class="px-3 py-2 text-left">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for retiro in retiros_crypto %}
          <tr class="hover:bg-white/5">
            <td class="px-3 py-2"><a class="text-accent hover:underline" href="{% url 'admin_usuario_perfil' retiro.usuario.id %}">{{ retiro.usuario.username }}</a></td>
            <td class="px-3 py-2">{{ retiro.moneda }}</td>
            <td class="px-3 py-2">{{ retiro.monto }}</td>
            <td class="px-3 py-2 break-all">{{ retiro.direccion_wallet }}</td>
            <td class="px-3 py-2 capitalize">
              <span class="px-2 py-0.5 rounded border text-xs
                {% if retiro.estado == 'aprobado' %} border-emerald-400 text-emerald-300
                {% elif retiro.estado == 'pendiente' %} border-amber-400 text-amber-300
                {% else %} border-red-400 text-red-300 {% endif %}">
                {{ retiro.estado }}
              </span>
            </td>
            <td class="px-3 py-2">
              {% if retiro.estado == 'pendiente' %}
              <form method="post" action="{% url 'aprobar_retiro_cripto' retiro.id %}">{% csrf_token %}
                <button class="rounded-md bg-neon text-black px-3 py-1 font-semibold">Aprobar</button>
              </form>
              <form method="post" action="{% url 'rechazar_retiro_cripto' retiro.id %}">{% csrf_token %}
                <button class="rounded-md border border-white/10 px-3 py-1 hover:bg-white/5">Rechazar</button>
              </form>
              {% else %}
              <span class="text-black/60">‚Äî</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="6" class="px-3 py-4 text-black/60 text-center">No hay retiros CRYPTO pendientes.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Dep√≥sitos -->
  <section id="panel-depositos" data-panel="depositos" class="space-y-4 hidden">
    <h2 class="text-lg font-semibold">Dep√≥sitos pendientes</h2>
    <div class="overflow-x-auto card p-0">
      <table class="w-full text-sm">
        <thead class="bg-white/5 text-accent">
          <tr>
            <th class="px-3 py-2 text-left">Usuario</th>
            <th class="px-3 py-2 text-left">Monto</th>
            <th class="px-3 py-2 text-left">Comprobante</th>
            <th class="px-3 py-2 text-left">Fecha</th>
            <th class="px-3 py-2 text-left">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for d in depositos %}
            {% if d.estado == 'pendiente' %}
            <tr class="hover:bg-white/5">
              <td class="px-3 py-2"><a class="text-accent hover:underline" href="{% url 'admin_usuario_perfil' d.usuario.id %}">{{ d.usuario.username }}</a></td>
              <td class="px-3 py-2">${{ d.monto }}</td>
              <td class="px-3 py-2">
                {% if d.comprobante %}
                  <button type="button" class="thumb-btn underline text-black/80 hover:text-neon" data-img="{{ d.comprobante.url }}">Ver</button>
                {% else %}<span class="text-black/40">‚Äî</span>{% endif %}
              </td>
              <td class="px-3 py-2">{{ d.fecha_subida|date:"d/m/Y H:i" }}</td>
              <td class="px-3 py-2">
                <form method="post" action="{% url 'aprobar_deposito' d.id %}">
                  {% csrf_token %}
                  <button class="rounded-md bg-neon text-black px-3 py-1 font-semibold">Aprobar</button>
                </form>
              </td>
            </tr>
            {% endif %}
          {% empty %}
            <tr><td colspan="5" class="px-3 py-4 text-black/60 text-center">Sin dep√≥sitos pendientes.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Exportar -->
  <section id="panel-export" data-panel="export" class="space-y-4 hidden">
    <h2 class="text-lg font-semibold">Exportar movimientos</h2>
    <form method="GET" action="{% url 'exportar_movimientos_admin' %}" class="card p-4 grid sm:grid-cols-5 gap-3">
      <label class="block">
        <span class="text-xs text-black/60">Desde</span>
        <input type="date" name="desde" class="w-full rounded-md border border-white/10 bg-white text-black px-3 py-2 focus:ring-2 focus:ring-neon">
      </label>
      <label class="block">
        <span class="text-xs text-black/60">Hasta</span>
        <input type="date" name="hasta" class="w-full rounded-md border border-white/10 bg-white text-black px-3 py-2 focus:ring-2 focus:ring-neon">
      </label>
      <label class="block">
        <span class="text-xs text-black/60">Moneda</span>
        <select name="moneda" class="w-full rounded-md border border-white/10 bg-white text-black px-3 py-2 focus:ring-2 focus:ring-neon">
          <option value="">Todas</option><option>ARS</option><option>USDT</option><option>USD</option>
        </select>
      </label>
      <label class="block">
        <span class="text-xs text-black/60">Tipo</span>
        <select name="tipo" class="w-full rounded-md border border-white/10 bg-white text-black px-3 py-2 focus:ring-2 focus:ring-neon">
          <option value="">Todos</option>
          <option value="deposito">Dep√≥sito</option>
          <option value="retiro">Retiro</option>
          <option value="compra">Compra</option>
          <option value="venta">Venta</option>
          <option value="ajuste">Ajuste</option>
        </select>
      </label>
      <div class="flex items-end">
        <button class="w-full rounded-lg bg-neon text-black font-semibold px-4 py-2">üì• Exportar</button>
      </div>
    </form>
  </section>

  <!-- √öltimos movimientos -->
  <section id="panel-movs" data-panel="movs" class="space-y-4 hidden">
    <h2 class="text-lg font-semibold">√öltimos movimientos</h2>
    <div class="overflow-x-auto card p-0">
      <table class="w-full text-sm">
        <thead class="bg-white/5 text-accent">
          <tr>
            <th class="px-3 py-2 text-left">Usuario</th>
            <th class="px-3 py-2 text-left">Tipo</th>
            <th class="px-3 py-2 text-left">Moneda</th>
            <th class="px-3 py-2 text-left">Monto</th>
            <th class="px-3 py-2 text-left">Descripci√≥n</th>
            <th class="px-3 py-2 text-left">Fecha</th>
            <th class="px-3 py-2 text-left">ID</th>
          </tr>
        </thead>
        <tbody>
          {% for m in movimientos %}
          <tr class="hover:bg-white/5">
            <td class="px-3 py-2"><a class="text-accent hover:underline" href="{% url 'admin_usuario_perfil' m.usuario.id %}">{{ m.usuario.username }}</a></td>
            <td class="px-3 py-2">{{ m.tipo }}</td>
            <td class="px-3 py-2">{{ m.moneda }}</td>
            <td class="px-3 py-2">{{ m.monto }}</td>
            <td class="px-3 py-2">{{ m.descripcion }}</td>
            <td class="px-3 py-2">{{ m.fecha|date:"d/m/Y H:i" }}</td>
            <td class="px-3 py-2 font-mono">{{ m.codigo }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="7" class="px-3 py-4 text-black/60 text-center">Sin registros recientes.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

</section>

<!-- Lightbox simple para im√°genes + tabs -->
<script>
(function(){
  // Tabs
  const panels = document.querySelectorAll('[data-panel]');
  const btns = document.querySelectorAll('.tab-btn');

  function show(tab){
    panels.forEach(p=>p.classList.toggle('hidden', p.dataset.panel!==tab));
    btns.forEach(b=>{
      const on = b.dataset.tab===tab;
      b.classList.toggle('bg-white/10', on);
      b.classList.toggle('text-black', on);
      b.setAttribute('aria-current', on ? 'page' : 'false');
    });
    history.replaceState(null,'', '#'+tab);
  }

  const initial = (location.hash||'#kyc').replace('#','');
  show(initial);
  btns.forEach(b=>b.addEventListener('click', (e)=>{ e.preventDefault(); show(b.dataset.tab); }));

  // Lightbox b√°sico
  const overlay = document.createElement('div');
  overlay.className = 'fixed inset-0 z-50 hidden items-center justify-center bg-black/70 p-4';
  overlay.innerHTML = `
    <div class="max-w-3xl w-full">
      <div class="relative card p-2">
        <button class="absolute -top-3 -right-3 rounded-full bg-neon text-black font-bold h-8 w-8" aria-label="Cerrar">√ó</button>
        <img id="lb-img" src="" class="w-full rounded-lg" alt="Comprobante/DNI">
      </div>
    </div>`;
  document.body.appendChild(overlay);
  const lbImg = overlay.querySelector('#lb-img');
  const closeBtn = overlay.querySelector('button');
  closeBtn.addEventListener('click', ()=> overlay.classList.add('hidden'));
  overlay.addEventListener('click', (e)=>{ if(e.target===overlay) overlay.classList.add('hidden'); });

  document.querySelectorAll('.thumb-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      lbImg.src = b.getAttribute('data-img');
      overlay.classList.remove('hidden');
    });
  });
})();
</script>
{% endblock %}
