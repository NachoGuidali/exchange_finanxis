{% extends "base.html" %}
{% block title %}Operar ‚Äî Finanxis{% endblock %}
{% block meta_description %}Compra, vende y hac√© swap entre USD y USDT con resumen de costos en vivo.{% endblock %}

{% block content %}

<section class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">

  <!-- SALDO + Contexto -->
  <header class="rounded-2xl border border-gray-200 bg-white p-5">
    <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-900">Operar</h1>
        <p class="text-gray-600">Compr√°, vend√© o hac√© swap entre <b>USD</b> y <b>USDT</b>, con costos transparentes.</p>
      </div>
      <a href="{% url 'comprobantes' %}" class="rounded-xl border border-gray-200 bg-white px-4 py-2 text-sm hover:bg-gray-50">üßæ Ver comprobantes</a>
    </div>

    <div class="mt-5 grid grid-cols-1 sm:grid-cols-3 gap-4">
      <div class="rounded-xl border border-gray-200 bg-white p-4">
        <p class="text-xs text-gray-500">Saldo ARS</p>
        <p class="mt-1 text-2xl font-extrabold text-gray-900">${{ request.user.saldo_ars }}</p>
      </div>
      <div class="rounded-xl border border-gray-200 bg-white p-4">
        <p class="text-xs text-gray-500">Saldo USDT</p>
        <p class="mt-1 text-2xl font-extrabold text-gray-900">{{ request.user.saldo_usdt }}</p>
      </div>
      <div class="rounded-xl border border-gray-200 bg-white p-4">
        <p class="text-xs text-gray-500">Saldo USD</p>
        <p class="mt-1 text-2xl font-extrabold text-gray-900">{{ request.user.saldo_usd|default:"0.00" }}</p>
      </div>
    </div>
  </header>

  <div class="mt-8 grid lg:grid-cols-12 gap-6">

    <!-- Columna principal -->
    <div class="lg:col-span-8 space-y-6">

      <!-- CARD CENTRAL: Tabs -->
      <section class="rounded-2xl border border-gray-200 bg-white">
        <!-- Tabs -->
        <div class="flex items-center gap-2 border-b border-gray-200 px-4 pt-3">
          <button data-tab="comprar" class="tab-btn active rounded-t-md px-4 py-2 text-sm font-medium text-gray-900 border-b-2 border-primary">Comprar</button>
          <button data-tab="vender"  class="tab-btn rounded-t-md px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900">Vender</button>
          <button data-tab="swap"    class="tab-btn rounded-t-md px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900">Swap</button>
        </div>

        <!-- Contenido -->
        <div class="p-5">

          <!-- COMPRAR -->
          <div class="tab-panel" id="panel-comprar">
            <form method="POST" class="op-form space-y-4" data-op="compra">
              {% csrf_token %}
              <input type="hidden" name="operacion" value="compra" />
              <div class="grid gap-4 sm:grid-cols-2">
                <div>
                  <label class="mb-1 block text-sm text-gray-700">Quiero comprar</label>
                  <select name="moneda" required
                          class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-gray-900 focus:border-primary focus:ring-0">
                    <option value="USDT" data-venta="{{ cot_usdt.venta }}" data-saldo-origen="{{ request.user.saldo_ars|default:'0' }}" data-origen="ARS">USDT ‚Äî Venta: ${{ cot_usdt.venta }}</option>
                    <option value="USD"  data-venta="{{ cot_usd.venta  }}" data-saldo-origen="{{ request.user.saldo_ars|default:'0' }}" data-origen="ARS">USD ‚Äî Venta: ${{ cot_usd.venta }}</option>
                  </select>
                  <p class="mt-1 text-xs text-gray-500">Se descuenta de tu saldo ARS al precio de <b>venta</b>.</p>
                </div>
                <div>
                  <label class="mb-1 block text-sm text-gray-700">Monto en ARS</label>
                  <input name="monto" step="0.01" type="number" min="0" required
                         class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-gray-900 focus:border-primary focus:ring-0" />
                </div>
              </div>

              <!-- Resumen -->
              <div class="rounded-xl border border-primary/20 bg-primary/5 p-4 text-sm" aria-live="polite">
                <div class="flex flex-wrap gap-x-6 gap-y-2">
                  <div>üí∞ ARS a usar: <b id="c-ars">‚Äî</b></div>
                  <div>üí± Cotizaci√≥n venta: <b id="c-rate">‚Äî</b></div>
                  <div>üì• Recibir√°s: <b id="c-recibe">‚Äî</b> <span id="c-sym"></span></div>
                </div>
                <p class="mt-2 text-[12px] text-gray-600">La comisi√≥n ya puede estar incluida en la cotizaci√≥n. Valores estimados.</p>
                <p id="c-warning" class="mt-1 text-[12px] text-red-600 hidden">Saldo ARS insuficiente.</p>
              </div>

              <button class="w-full rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-dark shadow-soft hover:opacity-90 disabled:opacity-50" disabled>Comprar</button>
            </form>
          </div>

          <!-- VENDER -->
          <div class="tab-panel hidden" id="panel-vender">
            <form method="POST" class="op-form space-y-4" data-op="venta">
              {% csrf_token %}
              <input type="hidden" name="operacion" value="venta" />
              <div class="grid gap-4 sm:grid-cols-2">
                <div>
                  <label class="mb-1 block text-sm text-gray-700">Quiero vender</label>
                  <select name="moneda" required
                          class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-gray-900 focus:border-primary focus:ring-0">
                    <option value="USDT" data-compra="{{ cot_usdt.compra }}" data-saldo-origen="{{ request.user.saldo_usdt|default:'0' }}" data-origen="USDT">USDT ‚Äî Compra: ${{ cot_usdt.compra }}</option>
                    <option value="USD"  data-compra="{{ cot_usd.compra  }}" data-saldo-origen="{{ request.user.saldo_usd|default:'0'  }}" data-origen="USD">USD ‚Äî Compra: ${{ cot_usd.compra }}</option>
                  </select>
                  <p class="mt-1 text-xs text-gray-500">Se acredita en ARS al precio de <b>compra</b>.</p>
                </div>
                <div>
                  <label class="mb-1 block text-sm text-gray-700">Monto a vender (USDT/USD)</label>
                  <input name="monto" step="0.01" type="number" min="0" required
                         class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-gray-900 focus:border-primary focus:ring-0" />
                </div>
              </div>

              <!-- Resumen -->
              <div class="rounded-xl border border-primary/20 bg-primary/5 p-4 text-sm" aria-live="polite">
                <div class="flex flex-wrap gap-x-6 gap-y-2">
                  <div>ü™ô A vender: <b id="v-monto">‚Äî</b> <span id="v-sym"></span></div>
                  <div>üí± Cotizaci√≥n compra: <b id="v-rate">‚Äî</b></div>
                  <div>üì§ Recibir√°s: <b id="v-ars">‚Äî</b> ARS</div>
                </div>
                <p class="mt-2 text-[12px] text-gray-600">La comisi√≥n puede estar incluida en la cotizaci√≥n. Valores estimados.</p>
                <p id="v-warning" class="mt-1 text-[12px] text-red-600 hidden">Saldo insuficiente.</p>
              </div>

              <button class="w-full rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-dark shadow-soft hover:opacity-90 disabled:opacity-50" disabled>Vender</button>
            </form>
          </div>

          <!-- SWAP -->
          <div class="tab-panel hidden" id="panel-swap">
            <form method="POST" class="op-form space-y-4" data-op="swap">
              {% csrf_token %}
              <input type="hidden" name="operacion" value="swap" />
              <div class="grid gap-4 sm:grid-cols-2">
                <div>
                  <label class="mb-1 block text-sm text-gray-700">Direcci√≥n</label>
                  <select name="swap_direccion" required
                          class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-gray-900 focus:border-primary focus:ring-0">
                    <option value="USD_to_USDT" data-saldo-origen="{{ request.user.saldo_usd|default:'0'  }}">USD ‚Üí USDT</option>
                    <option value="USDT_to_USD" data-saldo-origen="{{ request.user.saldo_usdt|default:'0' }}">USDT ‚Üí USD</option>
                  </select>
                  <p class="mt-1 text-xs text-gray-500">Tasa base: {{ swap_rate }} | Comisi√≥n: {{ swap_fee_bps }} bps</p>
                </div>
                <div>
                  <label class="mb-1 block text-sm text-gray-700">Monto (moneda de origen)</label>
                  <input name="monto" step="0.01" type="number" min="0" required
                         class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-gray-900 focus:border-primary focus:ring-0" />
                </div>
              </div>

              <!-- Resumen -->
              <div class="rounded-xl border border-primary/20 bg-primary/5 p-4 text-sm" aria-live="polite">
                <div class="flex flex-wrap gap-x-6 gap-y-2">
                  <div>üîÅ Ruta: <b id="s-route">‚Äî</b></div>
                  <div>üí± Tasa base: <b id="s-rate">{{ swap_rate }}</b></div>
                  <div>üßæ Comisi√≥n: <b id="s-fee">{{ swap_fee_bps }}</b> bps</div>
                  <div>üì• Recibir√°s: <b id="s-recibe">‚Äî</b></div>
                </div>
                <p class="mt-2 text-[12px] text-gray-600">El resultado se acredita <b>neto</b> de comisi√≥n en la moneda destino.</p>
                <p id="s-warning" class="mt-1 text-[12px] text-red-600 hidden">Saldo insuficiente.</p>
              </div>

              <button class="w-full rounded-xl bg-primary px-4 py-3 text-sm font-semibold text-dark shadow-soft hover:opacity-90 disabled:opacity-50" disabled>Convertir</button>
            </form>
          </div>

        </div>
      </section>

      <!-- Ayuda contextual -->
      <section class="rounded-2xl border border-gray-200 bg-white p-5">
        <h3 class="text-lg font-semibold text-gray-900">Ayuda</h3>
        <p class="text-sm text-gray-700 mt-1">
          En <b>Comprar</b> ingres√°s ARS y recib√≠s USD/USDT. En <b>Vender</b> ingres√°s USD/USDT y recib√≠s ARS. En <b>Swap</b> convert√≠s USD ‚áÑ USDT.
          Verific√° tu identidad y activ√° 2FA para mayores l√≠mites y seguridad.
        </p>
      </section>

    </div>

    <!-- Sidebar: checklist + cotizaciones -->
    <aside class="lg:col-span-4 space-y-6">
      <!-- Checklist -->
      <section class="rounded-2xl border border-gray-200 bg-white p-5">
        <h3 class="font-semibold text-gray-900">Checklist de cuenta</h3>
        <ol class="mt-3 grid gap-3 text-sm">
          <li class="rounded-xl border border-gray-200 bg-gray-50 px-3 py-2 flex items-start gap-2">
            {% if request.user.estado_verificacion == 'aprobado' %}‚úÖ{% else %}‚óªÔ∏è{% endif %}
            <div><div class="font-medium">Verificaci√≥n de identidad</div>
              {% if request.user.estado_verificacion != 'aprobado' %}
                <a href="{% url 'perfil' %}" class="text-primary underline text-xs">Completar KYC</a>
              {% else %}
                <div class="text-gray-600 text-xs">Listo</div>
              {% endif %}
            </div>
          </li>
          <!-- <li class="rounded-xl border border-gray-200 bg-gray-50 px-3 py-2 flex items-start gap-2">
            {% if request.user.has_2fa %}‚úÖ{% else %}‚óªÔ∏è{% endif %}
            <div><div class="font-medium">Activar 2FA</div>
              {% if not request.user.has_2fa %}<a href="#" class="text-primary underline text-xs">Configurar</a>{% else %}<div class="text-gray-600 text-xs">Protegida</div>{% endif %}
            </div>
          </li> -->
          <li class="rounded-xl border border-gray-200 bg-gray-50 px-3 py-2">
            üí∏ Ten√© saldo ARS o USD/USDT para operar. <a href="{% url 'agregar_saldo' %}" class="text-primary underline text-xs">Agregar saldo</a>
          </li>
        </ol>
      </section>

      <!-- Cotizaciones -->
      <section class="rounded-2xl border border-gray-200 bg-white p-5 text-sm">
        <h3 class="text-center font-semibold text-gray-900">Cotizaciones</h3>
        <div class="mt-3 grid grid-cols-2 gap-3">
          <div class="rounded-xl border border-gray-200 bg-gray-50 p-3">
            <div class="text-xs text-gray-600">USDT</div>
            <div class="mt-1 flex justify-between text-gray-800"><span>Compra</span><span class="font-semibold">${{ cot_usdt.compra }}</span></div>
            <div class="mt-1 flex justify-between text-gray-800"><span>Venta</span><span class="font-semibold">${{ cot_usdt.venta }}</span></div>
          </div>
          <div class="rounded-xl border border-gray-200 bg-gray-50 p-3">
            <div class="text-xs text-gray-600">USD</div>
            <div class="mt-1 flex justify-between text-gray-800"><span>Compra</span><span class="font-semibold">${{ cot_usd.compra }}</span></div>
            <div class="mt-1 flex justify-between text-gray-800"><span>Venta</span><span class="font-semibold">${{ cot_usd.venta }}</span></div>
          </div>
        </div>
        <p class="mt-3 text-[11px] text-gray-500 text-center">Referencial; puede variar por volumen/m√©todo.</p>
      </section>
    </aside>

  </div>
</section>

<script>
(function () {
  // Tabs
  const tabBtns = document.querySelectorAll('.tab-btn');
  const panels = {
    comprar: document.getElementById('panel-comprar'),
    vender:  document.getElementById('panel-vender'),
    swap:    document.getElementById('panel-swap'),
  };
  function activate(tab) {
    tabBtns.forEach(b => {
      const on = b.dataset.tab === tab;
      b.classList.toggle('active', on);
      b.classList.toggle('text-gray-900', on);
      b.classList.toggle('text-gray-600', !on);
      b.classList.toggle('border-b-2', on);
      b.style.borderColor = on ? '#FF1129' : 'transparent';
    });
    Object.entries(panels).forEach(([k, el]) => el.classList.toggle('hidden', k !== tab));
  }
  tabBtns.forEach(b => b.addEventListener('click', () => activate(b.dataset.tab)));
  activate('comprar');

  // Helpers robustos
  const fmt = (v) => Number(v||0).toLocaleString('es-AR',{minimumFractionDigits:2,maximumFractionDigits:2});
  const toNumber = (v) => {
    if (typeof v === 'number') return v;
    if (v === null || v === undefined) return 0;
    let s = String(v).trim().replace(/\s+/g,'');
    if (s.includes('.') && s.includes(',')) s = s.replace(/\./g,'').replace(',', '.');
    else if (s.includes(',')) s = s.replace(',', '.');
    const n = Number(s);
    return isNaN(n) ? 0 : n;
  };
  const getNumData = (el, key) => {
    const ds = el?.dataset || {};
    return toNumber(ds[key] ?? ds[key.replace(/([A-Z])/g,'_$1').toLowerCase()]);
  };
  const setDisabled = (btn, val) => {
    if (!btn) return;
    btn.disabled = !!val;
    if (val) btn.setAttribute('disabled','disabled');
    else btn.removeAttribute('disabled');
  };

  // === COMPRA ===
  (function(){
    const form = document.querySelector('form.op-form[data-op="compra"]'); if(!form) return;
    const sel  = form.querySelector('select[name="moneda"]');
    const inp  = form.querySelector('input[name="monto"]');
    const btn  = form.querySelector('button[type="submit"], button:not([type])');
    const ars  = document.getElementById('c-ars');
    const rate = document.getElementById('c-rate');
    const rec  = document.getElementById('c-recibe');
    const sym  = document.getElementById('c-sym');
    const warn = document.getElementById('c-warning');

    function update(){
      const montoARS = toNumber(inp.value);
      const opt = sel.selectedOptions[0];
      const pVenta = getNumData(opt, 'venta');
      const saldoOrigen = getNumData(opt, 'saldoOrigen');
      sym.textContent  = sel.value;
      ars.textContent  = `\$ ${fmt(montoARS)}`;
      rate.textContent = `\$ ${fmt(pVenta)}`;
      const ok = montoARS>0 && pVenta>0;
      const recibe = ok ? (montoARS / pVenta) : 0;
      rec.textContent = ok ? fmt(recibe) : '‚Äî';
      const insuf = ok && (montoARS > saldoOrigen);
      warn.classList.toggle('hidden', !insuf);
      setDisabled(btn, !ok || insuf);
    }
    sel.addEventListener('change', update);
    inp.addEventListener('input', update);
    update();

    form.addEventListener('submit', function(e){
      const opt = sel.selectedOptions[0];
      const pVenta = getNumData(opt, 'venta');
      const montoARS = toNumber(inp.value);
      const recibe = (montoARS / pVenta);
      if(!confirm(`Confirmar COMPRA de ${sel.value}\nARS: $${fmt(montoARS)}\nCotizaci√≥n venta: $${fmt(pVenta)}\nRecibir√°s: ${fmt(recibe)} ${sel.value}`)){
        e.preventDefault();
      } else {
        setDisabled(btn, true); btn.textContent = 'Procesando...';
      }
    });
  })();

  // === VENTA ===
  (function(){
    const form = document.querySelector('form.op-form[data-op="venta"]'); if(!form) return;
    const sel  = form.querySelector('select[name="moneda"]');
    const inp  = form.querySelector('input[name="monto"]');
    const btn  = form.querySelector('button[type="submit"], button:not([type])');
    const vMonto = document.getElementById('v-monto');
    const vRate  = document.getElementById('v-rate');
    const vARS   = document.getElementById('v-ars');
    const vSym   = document.getElementById('v-sym');
    const warn   = document.getElementById('v-warning');

    function update(){
      const monto = toNumber(inp.value);
      const opt = sel.selectedOptions[0];
      const pCompra = getNumData(opt, 'compra');
      const saldoOrigen = getNumData(opt, 'saldoOrigen');
      vSym.textContent   = sel.value;
      vMonto.textContent = fmt(monto);
      vRate.textContent  = `\$ ${fmt(pCompra)}`;
      const ok = monto>0 && pCompra>0;
      const recibeARS = ok ? (monto * pCompra) : 0;
      vARS.textContent = ok ? `\$ ${fmt(recibeARS)}` : '‚Äî';
      const insuf = ok && (monto > saldoOrigen);
      warn.classList.toggle('hidden', !insuf);
      setDisabled(btn, !ok || insuf);
    }
    sel.addEventListener('change', update);
    inp.addEventListener('input', update);
    update();

    form.addEventListener('submit', function(e){
      const opt = sel.selectedOptions[0];
      const pCompra = getNumData(opt, 'compra');
      const monto   = toNumber(inp.value);
      const recibe  = (monto * pCompra);
      if(!confirm(`Confirmar VENTA de ${fmt(monto)} ${sel.value}\nCotizaci√≥n compra: $${fmt(pCompra)}\nRecibir√°s: $${fmt(recibe)} ARS`)){
        e.preventDefault();
      } else {
        setDisabled(btn, true); btn.textContent = 'Procesando...';
      }
    });
  })();

  // === SWAP ===
  (function(){
    const form = document.querySelector('form.op-form[data-op="swap"]'); if(!form) return;
    const sel  = form.querySelector('select[name="swap_direccion"]');
    const inp  = form.querySelector('input[name="monto"]');
    const btn  = form.querySelector('button[type="submit"], button:not([type])');
    const sRoute = document.getElementById('s-route');
    const sRate  = document.getElementById('s-rate');
    const sFee   = document.getElementById('s-fee');
    const sRec   = document.getElementById('s-recibe');
    const warn   = document.getElementById('s-warning');

    const SWAP_RATE   = toNumber('{{ swap_rate|default:"1.00" }}');
    const SWAP_FEE_BPS= toNumber('{{ swap_fee_bps|default:"100" }}');
    const FEE_FACTOR  = 1 - (SWAP_FEE_BPS / 10000);

    function update(){
      const dir   = sel.value;
      const monto = toNumber(inp.value);
      const saldoOrigen = getNumData(sel.selectedOptions[0], 'saldoOrigen');
      sRoute.textContent = dir === 'USD_to_USDT' ? 'USD ‚Üí USDT' : 'USDT ‚Üí USD';
      sRate.textContent  = fmt(SWAP_RATE);
      sFee.textContent   = SWAP_FEE_BPS;

      const ok = monto > 0 && SWAP_RATE > 0;
      let recibe = 0, label = '';
      if (dir === 'USD_to_USDT') { recibe = monto * SWAP_RATE * FEE_FACTOR; label = 'USDT'; }
      else { recibe = (monto / SWAP_RATE) * FEE_FACTOR; label = 'USD'; }
      sRec.textContent = ok ? `${fmt(recibe)} ${label}` : '‚Äî';

      const insuf = ok && (monto > saldoOrigen);
      warn.classList.toggle('hidden', !insuf);
      setDisabled(btn, !ok || insuf);
    }
    sel.addEventListener('change', update);
    inp.addEventListener('input', update);
    update();

    form.addEventListener('submit', function(e){
      const dir = sel.value;
      const monto = toNumber(inp.value);
      let recibe = dir==='USD_to_USDT' ? (monto * SWAP_RATE * FEE_FACTOR) : ((monto / SWAP_RATE) * FEE_FACTOR);
      const label = dir==='USD_to_USDT' ? 'USDT' : 'USD';
      if(!confirm(`Confirmar SWAP ${dir==='USD_to_USDT'?'USD ‚Üí USDT':'USDT ‚Üí USD'}\nMonto origen: ${fmt(monto)}\nTasa: ${fmt(SWAP_RATE)}\nComisi√≥n: ${SWAP_FEE_BPS} bps\nRecibir√°s: ${fmt(recibe)} ${label} (neto)`)){
        e.preventDefault();
      } else {
        setDisabled(btn, true); btn.textContent = 'Procesando...';
      }
    });
  })();
})();
</script>

{% endblock %}

